# 模型加载慢的问题和解决方案

## 问题现象

模型加载到最后阶段（99%）时很慢，例如：
```
model.safetensors:  99%|████████████████████████████████████████████████████████████████████████▍| 343M/346M [06:40<00:33, 86.1kB/s]
```

## 原因分析

### 1. **网络下载速度慢**
- 模型文件较大（~346MB）
- 从 HuggingFace 下载，网络速度可能不稳定
- 最后一部分下载速度可能变慢

### 2. **文件校验和解压过程**
- 下载完成后需要进行文件校验（确保文件完整性）
- 可能需要解压或转换格式
- 这些过程在最后阶段进行，可能看起来"卡住"

### 3. **磁盘 I/O 操作**
- 大文件写入磁盘需要时间
- 最后一部分写入可能较慢

## 这是正常的！

**重要提示**：模型加载在 99% 时变慢是**正常现象**，不是 bug！

- ✅ 文件正在下载/校验/解压
- ✅ 请耐心等待，通常需要 1-5 分钟
- ✅ 完成后会自动继续训练

## 优化方案

### 方案 1: 使用 HuggingFace 缓存（推荐）

模型下载后会缓存在本地，第二次加载会很快：

```bash
# 模型缓存位置（Linux/Mac）
~/.cache/huggingface/hub/

# 模型缓存位置（Windows）
C:\Users\<用户名>\.cache\huggingface\hub\
```

**优点**：
- 首次下载后，后续加载几乎瞬间完成
- 无需重复下载

### 方案 2: 手动下载模型（如果网络很慢）

如果网络非常慢，可以手动下载模型：

```bash
# 1. 安装 huggingface-hub
pip install huggingface-hub

# 2. 下载模型
python -c "
from huggingface_hub import snapshot_download
snapshot_download(
    repo_id='timm/eva02_large_patch14_clip_336.merged2b_ft_inat21',
    local_dir='./models/eva02_large',
    local_dir_use_symlinks=False
)
"

# 3. 使用本地模型（需要修改代码或设置环境变量）
export HF_HOME=./models
```

### 方案 3: 使用镜像站点（国内用户）

如果访问 HuggingFace 很慢，可以使用镜像：

```bash
# 设置环境变量使用镜像
export HF_ENDPOINT=https://hf-mirror.com

# 或者在代码中设置
import os
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
```

### 方案 4: 预下载模型（训练前）

在训练前先下载模型，避免训练时等待：

```python
# 创建一个预下载脚本 pre_download_model.py
import timm

print("开始下载模型...")
model = timm.create_model(
    'hf_hub:timm/eva02_large_patch14_clip_336.merged2b_ft_inat21',
    pretrained=True,
)
print("模型下载完成！")
del model
```

运行：
```bash
python pre_download_model.py
```

### 方案 5: 使用较小的模型（如果不需要大模型）

如果数据集较小，可以使用较小的模型：

```bash
# 使用较小的模型
python train.py \
    --model hf_hub:timm/eva02_base_patch14_clip_336.merged2b_ft_inat21 \
    # 或者
    --model resnet50
```

## 检查下载进度

### 查看缓存目录

```bash
# 查看已下载的模型
ls -lh ~/.cache/huggingface/hub/models--timm--eva02_large_patch14_clip_336.merged2b_ft_inat21/
```

### 监控网络活动

```bash
# Linux: 监控网络流量
sudo iftop

# 或使用 nethogs 查看进程网络使用
sudo nethogs
```

## 常见问题

### Q: 下载到 99% 就卡住了，怎么办？

**A**: 这是正常的，请耐心等待：
- 文件校验需要时间
- 解压/转换需要时间
- 通常 1-5 分钟内会完成

### Q: 下载失败怎么办？

**A**: 
1. 检查网络连接
2. 使用镜像站点（见方案 3）
3. 手动下载（见方案 2）
4. 重试（timm 会自动重试）

### Q: 如何知道下载是否真的卡住了？

**A**: 
- 如果超过 10 分钟没有进度，可能是真的卡住了
- 检查网络连接
- 查看是否有错误信息
- 可以 Ctrl+C 中断后重试

### Q: 第二次训练还需要下载吗？

**A**: 不需要！模型已缓存在本地，第二次加载会很快（几秒钟）。

## 预期时间

根据网络速度，模型下载时间：

| 网络速度 | 预计时间 |
|---------|---------|
| 1 MB/s  | ~6 分钟 |
| 5 MB/s  | ~1 分钟 |
| 10 MB/s | ~30 秒  |
| 100 MB/s| ~3 秒   |

**注意**：最后 1% 的校验/解压过程可能需要额外 1-2 分钟。

## 总结

1. **99% 时变慢是正常的** - 文件校验/解压过程
2. **首次下载后会有缓存** - 后续加载很快
3. **如果网络很慢** - 可以使用镜像或手动下载
4. **耐心等待** - 通常 1-5 分钟内会完成

---

**建议**：首次训练时，可以在开始训练前先运行一次模型加载，让模型下载完成，然后再正式训练。
